# 深度智能体 AI 助手（WEB）全局业务概览设计

## 1. 产品定位与成功标准
- 面向制造业全岗位的智能体助手，统一入口：对话驱动任务编排，覆盖生产/设备、质量/实验室、工艺/计划、供应链/采购及通用行政知识问答。
- 核心价值：降低知识门槛、缩短决策与执行链路，将对话转化为动作（查询、分析、生成、调用外部工具）。
- 使用形态：纯 WEB 前端，包含会话列表、对话区、主窗口、资源管理器（类文件系统，聚合业务数据与工具入口）。
- 成功标准：新用户 5 分钟内完成首个对话任务；常用操作 3 步内完成；意图识别准确率 ≥ 90%，多轮上下文 30 分钟不丢失，工具调度成功率 ≥ 95%；默认提供通用模板并支持自定义模型/工具/提示词；配置可热更新。

## 2. 整体架构与功能分层
- 前端（WEB SPA）：四区布局；负责对话输入、多模态展示（文本/表格/图表）、资源浏览与工具触发。
- 网关与登录：统一入口，登录鉴权、限流与基础日志。
- 会话与编排层：意图识别与会话管理；任务编排/工具路由可插拔，支持提示词/策略选择模型与工具链。
- 模型与提示词配置：模型注册表（URL/Key/模型名）；提示词模板库（系统/角色/工具调用），运行时组合选择。
- 资源管理器与数据接入：资源以“文件系统”模式聚合（工单、日志、质检报告、物料/供应链、知识库等），元数据索引、预览、过滤。
- 工具/服务层：标准化工具接口（检索、SQL/时序查询、工单/CMMS、MES/ERP/PLM、质量/实验室、外部知识库等）。
- 观测与运维：基础日志/指标；会话与工具调用看板；配置热更新；异常告警（可选）。

## 3. 核心用户旅程与关键用例
- 用户旅程：登录→加载会话与配置→输入问题（可选资源范围）→编排层选择模型/工具链→执行并流式返回→主窗口展示结果→追问/切换模型或提示词→导出/复制。
- 关键用例（通用版）：  
  - 生产/设备：故障问诊→日志/指标查询→维保建议与备件清单。  
  - 质量/实验室：不良描述→检索标准/案例→生成 8D 初稿或实验方案。  
  - 工艺/计划：工序/物料变更意图→拉取工艺卡/物料清单→生成调整建议与影响评估。  
  - 供应链/采购：询价/交期→查采购单/供应商→汇总对比并生成沟通话术。  
  - 通用行政/知识问答：检索知识库→摘要、流程指引或行动清单。

## 4. 界面信息架构与交互要点
- 信息架构：左侧会话列表（时间分组折叠、搜索/筛选、加载更多）；中部对话区（消息流 + 输入框，可切换模型/提示词，附加资源范围）；右侧主窗口（多 Tab 资源预览、结果卡片、图表、执行进度）；资源管理器（文件树，工单/日志/质检/物料/知识库/工具入口）。
- 关键交互：快捷键聚焦输入；支持粘贴多模态上下文；输入前勾选资源节点限定范围，主窗口可并行多个 Tab；工具执行进度与步骤日志可视化，失败给出重试建议；配置入口管理模型/提示词/工具策略并热更新；敏感内容可前端遮蔽（体验级，不做权限）。

## 5. 数据与资源模型（无多租户/权限）
- 资源分类：会话、工单/任务、日志与指标、质检/实验报告、物料与供应链文档、知识库、工具入口。
- 资源标记：名称、类型、业务域标签（生产/质量/计划/供应链/通用）、更新时间、数据源标识，便于过滤与上下文限定。
- 资源访问：默认对所有登录用户开放；敏感内容由源系统控制，前端以只读/预览呈现。
- 数据最小化：工具调用仅传必要字段；日志/指标查询可限定时间窗口与关键字；可选前端掩码显示敏感字段。
- 会话关联：会话可挂接资源引用（节点 ID/路径列表），便于多轮上下文范围限制与追溯。
- 导出与留存：会话与结果卡片支持导出/复制；系统日志仅供运维排障（可选开关）。

## 6. 模型/提示词/工具配置与编排策略
- 模型配置：设置中登记模型 URL/Key/模型名，可多模型并切换；支持温度/max tokens 等基础参数，失败重试与超时保护。
- 提示词管理：系统/角色/工具调用/自定义模板，变量占位（资源列表、业务域标签、历史摘要），发送前可预览合成内容，热更新生效。
- 工具与编排：工具注册含名称/入参/出参/描述/绑定提示词；意图分类后路由工具链，规则优先，必要时模型决策；支持顺序或并行，多工具结果模板归并并标注来源；失败提供参数建议并可回退为直接模型回答。
- 本地固定目录：资源管理器挂载固定目录文档，所选文件/目录作为检索范围，检索结果附加到模型上下文。
- 工具清单（当前可用）：internet_search、read_file、write_file、edit_file、ls、write_todos/todo 以及通用工具（兜底 Arguments+Result）；名为 task 且含 subagent_type 的调用作为子代理卡片，不进入工具列表。
- 工具调用前端展示：`ChatInterface` 将 AI 消息的 tool_calls 初始化为 pending（中断则为 interrupted），后续 tool 消息按 ID 写回 result 并置为 completed；`ChatMessage` 按消息内顺序渲染 ToolCallBox，过滤 task；ToolCallBox 提供状态条（pending 动效、interrupted 橙、error 红）、摘要、展开抽屉，优先级：生成式 UI（LoadExternalComponent，需 uiComponent+stream+graphId） > 审批中断（ToolApprovalInterrupt，需 actionRequest+reviewConfig+onResume） > 专用面板（搜索/读写/目录/todo） > 兜底 Arguments 折叠+Result 文本/JSON。状态文案“调用完成/调用中/调用失败/调用中断”，摘要按工具类型生成（搜索显示查询+结果数，读写/编辑显示路径与变更，目录显示路径与项数，todo 显示完成/总数，无匹配显示“工具调用”）。

## 7. 数据流与状态管理
- 前端状态：全局（用户配置、模型列表、提示词模板、工具注册）；会话域（消息流、选中资源、当前模型/提示词、工具执行状态）；视图域（主窗口多 Tab）。
- 数据获取：登录后批量拉取配置与资源索引；会话列表分页/时间分组加载；资源树懒加载子节点。
- 资源上下文：勾选资源后，将节点 ID/路径绑定到会话上下文，发送消息时连同范围传后端，用于检索/工具限定。
- 工具执行反馈：对话发送→后端编排→流式返回 token 或步骤日志→前端更新消息与主窗口进度卡片。
- 后端存储与交互：配置存储（模型/提示词/工具）；会话与消息分页存储并记录资源引用；资源索引定期扫描固定目录生成元数据/向量索引；编排层根据消息与资源范围选择模型与工具并合并结果，接口标准化支持同步/异步。

## 8. 非功能与体验要求
- 性能：对话首响应 < 2s，完整回答 < 10s（含工具调用）；资源树懒加载单层 < 1s；列表分页查询 < 1s。
- 可靠性：工具调用超时与重试机制；前端失败提示与重试入口；后端编排可降级为直接模型回答。
- 可扩展性：模型/工具/提示词均为注册表驱动，新增类型无需改核心编排；资源目录可新增业务分组；检索服务可替换/扩展向量引擎。
- 体验：多轮对话保持上下文；大结果支持折叠与一键导出/复制；结果卡片标注来源；长会话自动折叠历史并可加载更多。
- 安全基础：登录必经；避免在提示词或日志中泄漏敏感 Key；对外调用遵守超时与速率限制。

## 9. 可扩展方向与待决策
- 可选增强：多租户与权限体系、审计留痕、敏感操作二次确认；更丰富的多模态（文件上传/图片/语音）；工作流可视化与编排编辑器。
- 待决策：前端框架与组件库选型；向量检索方案（本地/托管）；日志与指标埋点范围；默认工具清单与优先级；固定目录的扫描频率与热更新方式；结果导出格式（Markdown/CSV/PDF）。

## 10. 小需求清单（含交互细节，WEB）
- 登录与初始加载：登录页账号/密码；成功后加载模型/提示词/工具配置、最近会话、资源树根；失败提示原因与重试；可跳过配置拉取进入主界面。
- 会话列表与历史折叠：按时间分组，近期展开，远期折叠；“加载更多”分页；搜索/筛选（关键字、标签、模型）；点击切换同步对话区与主窗口；悬停摘要；删除/重命名需确认。
- 对话输入与发送：输入框可选模型、提示词模板；粘贴文本/截图/日志生成附件卡片；发送后loading与“停止生成”；失败气泡内展示错误与“重试/复制请求”；快捷键 Enter 发送、Shift+Enter 换行、Ctrl/Cmd+K 聚焦。
- 资源管理器（固定目录文档）：文件树分组（会话、工单/任务、日志与指标、质检/实验、物料/供应链、知识库、工具入口）；懒加载子节点；节点“选中”挂到会话上下文，多选计数，可清空；预览浮层或主窗口 Tab；刷新重新扫描目录。
- 主窗口与多 Tab：对话结果默认开新卡片（文本/表格/图表/富视图）；手动关闭、固定、重排；工具执行展示进度与步骤日志，失败给出参数建议与“一键重试”。
- 模型配置与切换：设置页管理模型（名称、URL、Key 掩码、默认标记）；输入框下拉选择当前轮模型并标注在消息；超时或 401 弹出修正 Key 的提示与“去设置”入口。
- 提示词模板管理：设置页管理系统/工具/自定义模板，含变量占位示例与预览；对话前选择模板，发送前可展开查看合成结果；删除模板提示引用影响，变更热更新。
- 工具注册与调用路由：工具清单展示入参/出参样例/绑定提示词，可启用/禁用；发送时按规则/模型路由工具链，步骤在对话流或主窗口展示；失败自动重试一次，仍失败则退化为模型答复并提示缺失数据。
- 会话与资源上下文：每条消息记录资源节点列表，气泡可查看“上下文来源”；支持“清空上下文”与“恢复上次资源选择”；长会话折叠历史，滚动加载。
- 导出与复制：消息与结果卡片一键复制；表格/图表导出 CSV/PNG；对话导出 Markdown，含模型/工具调用摘要与资源来源；完成后轻量提示。
- 观测与故障提示（轻量）：基础日志/指标采集开关；显示请求耗时、工具步骤耗时摘要；统一错误提示样式（含追踪 ID）；用户反馈按钮可收集问题描述与截图。

