# Trae 风格 Web 对话智能体 - 高层业务文档（High-Level）

> 目标：构建一个类 Trae Solo 交互模式的 Web 对话界面，聚焦 AI 对话窗口及工具调用可视化，后台逻辑暂由占位或模拟数据提供。

## 1) 摘要与成功标准

- 业务目标：提供单页 Web AI 对话体验，突出工具调用的可视化、实时状态与结果逐层展开，覆盖文件读/写/检索、网络搜索、todo 任务写等工具类型。
- 关键 KPI / 成功度量：首帧响应 < 1.5s；工具状态更新延迟 < 0.8s；工具调用可视化点击展开率 > 60%；对话窗口可用性（无崩溃）≥ 99% 在演示期；用户满意度（可用性调研）≥ 4/5。
- 范围与上线时间：仅前端对话界面与工具可视化（接口可模拟），预计 2-3 周交付可演示版本；不含真实多模型编排与鉴权。

## 2) 业务蓝图

- 核心用户旅程/场景（4）：
  1. 用户打开页面看到空对话与工具提示；
  2. 用户输入问题，AI 给出思考并触发工具调用；
  3. 工具调用以卡片/时间线形式展示状态，并可逐层展开子项（如搜索结果条目、文件行片段）；
  4. 用户查看结果、复制/继续追问，历史对话可回看。
- 业务事件流（主干时序/状态转换）：输入提交 → 系统解析意图 → 工具队列生成 → 工具状态流（queued/running/streaming/result/error） → 子项批次推送 → 汇总回复 → 用户后续交互。
- 业务对象表（对象 | 核心属性 | 状态 | 备注）：
  - 对话消息 | id, role, content, toolRefs | 草稿/已发送 | 支持多段流式追加
  - 工具调用 | id, type(file-read/write/search/web-search/todo), status, progress, startedAt, duration, chunks | queued/running/streaming/done/error | 展示为卡片
  - 结果子项 | id, parentCallId, title, snippet, score/url/path | 新增/更新/折叠 | 支持层级展开
  - todo 任务 | id, title, status | 新建/更新 | 作为工具结果或后续指令

## 3) 核心流程（含 Mermaid）

- 角色分块的自然语言流程：
  - 普通用户主流程：打开页面 → 看到提示与工具说明 → 输入问题 → 观看 AI 思考/工具状态 → 展开结果 → 复制或追问。
  - 系统（前端代理）主流程：接收输入 → 生成并显示“思考中”占位 → 渲染工具调用卡片并订阅状态 → 流式更新内容与子项 → 合并结果生成回复气泡 → 提供重试/继续。
  - 其他（模拟后端）流程：按工具类型返回分阶段事件流（queued/running/partial/result）。
- Mermaid 流程图：

```mermaid
graph TD
  subgraph User
    U0[打开对话页]
    U1[输入提问]
    U2[查看工具卡片状态]
    U3[展开子项/搜索结果]
    U4[阅读最终回复]
    U5[继续追问或复制]
  end
  subgraph System
    S1[解析意图/生成工具计划]
    S2[创建工具调用卡片]
    S3[订阅状态流并更新UI]
    S4[分批追加子项内容]
    S5[汇总结果生成回复气泡]
    S6[提供重试/追加提问入口]
  end
  U0 --> U1 --> S1 --> S2 --> S3 --> S4 --> S5 --> U4 --> U5
  S3 -.实时状态-> U2
  S4 -.逐层展开-> U3
  U5 --> S6 --> S1
```

## 4) 能力分解与边界

- 一级能力（目的 | 输入 | 输出 | 触发）：
  1. 对话主窗口与流式展示 | 用户文本/系统事件流 | 分段追加的消息气泡 | 用户发送/系统回传
  2. 工具调用可视化 | 工具类型与状态事件 | 卡片/时间线、进度、错误提示 | 工具计划生成或事件推送
  3. 结果层级展开 | 子项批次（搜索条目、文件片段等） | 折叠/展开列表、滚动加载 | 用户点击或新批次推送
  4. 工具类型适配 | file-read/write/search、web-search、todo-write 事件 | 按类型定制的展示组件 | 工具事件到达
  5. 会话与历史管理 | 会话 id、消息与工具记录 | 本地/缓存的历史视图 | 页面加载或用户切换会话
  6. 失败与重试护栏 | 错误事件、超时信号 | 重试按钮、降级提示、保留上下文 | 状态 error/timeout
- Out-of-scope：真实模型调用编排；用户登录/权限/计费；多端（移动端）适配；文件真实写入到本地磁盘（仅模拟）；多轮协同编辑。

## 5) 非功能关键点（与业务紧耦合）

- 性能：首屏 < 1.5s；状态更新渲染 < 0.8s；展开列表虚拟化以支撑 ≥200 子项。
- 可观测性：前端埋点涵盖输入提交、工具状态变更、展开/折叠、错误、重试；控制台降噪与错误提示可见。
- 容错：工具卡片与消息分离渲染；单工具失败不阻断对话；超时提示+重试入口。
- 可用性/可达性：键盘可操作、屏幕阅读器友好（aria 标签）；浅色/深色模式；中英文文案切换预留。

## 6) speckit.specify 子任务清单

| 任务                | 目标                                                       | 输入上下文（引用本文件段落编号） | 输出物                  | 验收标准                               | 依赖 | 复杂度(0.5-2d) | 并行组 |
| ------------------- | ---------------------------------------------------------- | -------------------------------- | ----------------------- | -------------------------------------- | ---- | -------------- | ------ |
| 信息架构与 UI 草图  | 定义对话区、工具卡片、展开面板布局                         | §1, §2                           | 线框稿+组件说明         | 覆盖旅程 4 条，含工具与子项区域        | 无   | 1d             | A      |
| 对话流式渲染        | 支持消息分段追加与思考占位                                 | §3                               | 可交互对话组件          | 首帧 <1.5s，流式展示稳定               | A    | 1.5d           | B      |
| 工具卡片与状态机    | 展示 queued/running/streaming/done/error 与进度            | §2, §3, §4                       | 工具卡片组件+状态机定义 | 不同状态样式清晰，错误可重试           | A    | 1.5d           | B      |
| 结果子项展开/虚拟化 | 搜索/文件结果可分批、层级展开                              | §2, §4                           | 列表/树形组件           | 展开/折叠 <200ms，支持 ≥200 子项虚拟化 | B    | 1.5d           | C      |
| 工具类型适配皮肤    | 为 file-read/write/search、web-search、todo-write 定制展示 | §4                               | 类型化渲染配置          | 各类型示例渲染正确，含路径/URL/摘录    | B    | 1d             | C      |
| 错误与超时处理      | 统一错误提示与重试、降级回退                               | §4, §5                           | 错误处理策略+UI         | 超时提示 <1s，重试保持上下文           | B    | 1d             | C      |
| 观测与埋点          | 埋点方案与事件上报占位                                     | §5                               | 埋点清单+前端钩子       | 关键事件均可记录且不阻塞 UI            | B    | 0.5d           | D      |
| 会话历史与占位数据  | 本地缓存/模拟历史视图                                      | §4                               | 历史列表+切换逻辑       | 可切换会话且状态独立                   | B    | 1d             | D      |

> 长度控制：全稿 2-3 页；每节 3-7 项；句子尽量短。
